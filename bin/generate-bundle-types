#!/usr/bin/env bash
set -ex

REPO=sigstore/cosign
REF=a8ea54021bb6f850b30ee22bd15e0477d623e00d
PB_PATH=specs/dotsigstore_bundle/pb

mkdir -p /tmp/defs

curl -L --silent --show-error \
  -o /tmp/defs/envelope.proto \
  https://raw.githubusercontent.com/${REPO}/${REF}/${PB_PATH}/envelope.proto

curl -L --silent --show-error \
  -o /tmp/defs/bundle.proto \
  https://raw.githubusercontent.com/${REPO}/${REF}/${PB_PATH}/bundle.proto

protoc --plugin=./node_modules/.bin/protoc-gen-ts_proto \
  --ts_proto_out=${PWD}/src/bundle/__generated__ \
  --ts_proto_opt=forceLong=string \
  --ts_proto_opt=env=node \
  --ts_proto_opt=outputJsonMethods=true \
  --ts_proto_opt=outputEncodeMethods=false \
  --ts_proto_opt=outputPartialMethods=false \
  --ts_proto_opt=oneof=unions \
  --ts_proto_opt=unrecognizedEnum=false \
  --ts_proto_opt=exportCommonSymbols=false \
  -I /tmp/defs \
  /tmp/defs/bundle.proto
