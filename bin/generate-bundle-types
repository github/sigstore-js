#!/usr/bin/env sh
set -ex

if [ -z "${IN_CONTAINER}" ]; then
  cd $(dirname $0)/..
  IMAGE_NAME="sigstore-js-bundle-types"
  DOCKER_BUILDKIT=1 docker build -f Dockerfile.bundle-types -t ${IMAGE_NAME} .
  exec docker run --rm --net=none \
    --env OUTPUT_DIR=/sigstore-js \
    -v $(pwd):/sigstore-js ${IMAGE_NAME}
fi

OUTPUT_DIR="${OUTPUT_DIR:-.}"
DEFS_DIR="${DEFS_DIR:-./tmp/defs}"

mkdir -p ${OUTPUT_DIR}/src/bundle/__generated__

protoc --plugin=./node_modules/.bin/protoc-gen-ts_proto \
  --ts_proto_out=${OUTPUT_DIR}/src/bundle/__generated__ \
  --ts_proto_opt=forceLong=string \
  --ts_proto_opt=env=node \
  --ts_proto_opt=outputJsonMethods=true \
  --ts_proto_opt=outputEncodeMethods=false \
  --ts_proto_opt=outputPartialMethods=false \
  --ts_proto_opt=oneof=unions \
  --ts_proto_opt=unrecognizedEnum=false \
  --ts_proto_opt=exportCommonSymbols=false \
  -I ${DEFS_DIR} \
  ${DEFS_DIR}/bundle.proto
